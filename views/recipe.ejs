<% /* Note: The JSON-LD schema is already included in layout.ejs */ %>
<div class="max-w-6xl mx-auto px-4 py-8">
            <!-- Breadcrumbs -->
            <div class="text-sm text-gray-500 mb-6">
                <a href="/" class="hover:text-orange-500">Home</a> &raquo; 
                <a href="/recipes" class="hover:text-orange-500">Recipes</a> &raquo;
                <a href="/brands/<%= recipe.brandSlug %>/" class="hover:text-orange-500"><%= recipe.brand %></a> &raquo;
                <span class="text-gray-700"><%= recipe.title %></span>
            </div>

            <!-- Recipe Header -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                <div class="p-8">
                    <div class="md:flex">
                        <div class="md:w-2/3 pr-6">
                            <div class="uppercase tracking-wide text-sm text-orange-500 font-semibold"><%= recipe.brand %> Copycat</div>
                            <h1 class="text-3xl font-bold text-slate-900 mt-1 mb-3"><%= recipe.title %></h1>
                            <p class="text-slate-600 mb-4"><%= recipe.description || "A delicious homemade version of this popular recipe" %></p>
                            
                            <!-- Rating Display -->
                            <div class="flex items-center mb-4">
                                <div class="flex text-yellow-400">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                </div>
                                <span class="text-slate-700 ml-2 rating-display"><%= recipe.rating ? recipe.rating.value : '4.5' %> (<%= recipe.rating ? recipe.rating.count : '0' %> reviews)</span>
                            </div>
                            
                            <!-- Recipe Meta -->
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="text-slate-600">
                                    <span class="font-semibold text-slate-800">Category:</span> 
                                    <a href="/categories/<%= recipe.foodTypeSlug %>/" class="hover:text-orange-500"><%= recipe.foodType || 'Recipe' %></a>
                                </div>
                                <div class="text-slate-600">
                                    <span class="font-semibold text-slate-800">Brand:</span> 
                                    <a href="/brands/<%= recipe.brandSlug %>/" class="hover:text-orange-500"><%= recipe.brand %></a>
                                </div>
                                
                                <!-- Recipe Time Information -->
                                <% if (recipe.prepTime || recipe.cookTime || recipe.totalTime || recipe.difficulty) { %>
                                <div class="col-span-2 mt-4">
                                    <h3 class="font-semibold text-slate-800 mb-2">Recipe Details:</h3>
                                    <div class="flex flex-wrap gap-4">
                                        <% if (recipe.prepTime) { %>
                                        <div class="flex items-center">
                                            <div class="bg-orange-100 p-2 rounded-full mr-2">
                                                <svg class="w-4 h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                </svg>
                                            </div>
                                            <span><span class="font-medium">Prep:</span> <%= recipe.prepTime %></span>
                                        </div>
                                        <% } %>
                                        
                                        <% if (recipe.cookTime) { %>
                                        <div class="flex items-center">
                                            <div class="bg-blue-100 p-2 rounded-full mr-2">
                                                <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                                </svg>
                                            </div>
                                            <span><span class="font-medium">Cook:</span> <%= recipe.cookTime %></span>
                                        </div>
                                        <% } %>
                                        
                                        <% if (recipe.totalTime) { %>
                                        <div class="flex items-center">
                                            <div class="bg-purple-100 p-2 rounded-full mr-2">
                                                <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </div>
                                            <span><span class="font-medium">Total:</span> <%= recipe.totalTime %></span>
                                        </div>
                                        <% } %>
                                        
                                        <% if (recipe.difficulty) { %>
                                        <div class="flex items-center">
                                            <div class="bg-yellow-100 p-2 rounded-full mr-2">
                                                <svg class="w-4 h-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                                </svg>
                                            </div>
                                            <span><span class="font-medium">Difficulty:</span> <%= recipe.difficulty %></span>
                                        </div>
                                        <% } %>
                                    </div>
                                </div>
                                <% } %>
</div>
                        </div>
                        
                        <div class="md:w-1/3 mt-6 md:mt-0">
                            <img src="<%= recipe.image %>" alt="<%= recipe.title %>" class="w-full h-auto rounded-lg shadow-md" onerror="this.src='/images/placeholder.png'">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recipe Content -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                <div class="p-8">
                    <% if (recipe.parsedContent) { %>
                        <%- recipe.parsedContent %>
                    <% } else { %>
                        <div class="recipe-content prose max-w-none">
                            <h2 class="text-2xl font-bold text-slate-900 mb-4">About This Recipe</h2>
                            <p>This is a copycat recipe for <%= recipe.brand %>'s <%= recipe.title %>. Follow the instructions below to make this delicious recipe at home.</p>
                            
                            <% if (recipe.ingredients && recipe.ingredients.length > 0) { %>
                                <h3 class="text-xl font-bold text-slate-900 mb-3 mt-6">Ingredients</h3>
                                <ul class="list-disc pl-5 mb-6">
                                    <% recipe.ingredients.forEach(ingredient => { %>
                                        <li class="mb-1"><%= ingredient %></li>
                                    <% }); %>
                                </ul>
                            <% } %>
                            
                            <% if (recipe.instructions && recipe.instructions.length > 0) { %>
                                <h3 class="text-xl font-bold text-slate-900 mb-3 mt-6">Instructions</h3>
                                <ol class="list-decimal pl-5 mb-6">
                                    <% recipe.instructions.forEach(instruction => { %>
                                        <li class="mb-2"><%= instruction %></li>
                                    <% }); %>
                                </ol>
                            <% } %>
                        </div>
                    <% } %>
                </div>
            </div>
            
            <!-- User Rating Section -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                <div class="p-8">
                    <h3 class="text-xl font-bold text-slate-900 mb-4">Rate This Recipe</h3>
                    <form id="ratingForm" class="flex items-center">
                        <input type="hidden" name="recipeId" value="<%= recipe._id || recipe.brandSlug + '/' + recipe.slug %>">
                        <input type="hidden" id="ratingValue" name="rating" value="5">
                        
                        <div id="ratingStars" class="flex text-gray-300">
                            <button type="button" class="star-btn text-yellow-400" data-value="1">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            </button>
                            <button type="button" class="star-btn text-yellow-400" data-value="2">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            </button>
                            <button type="button" class="star-btn text-yellow-400" data-value="3">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            </button>
                            <button type="button" class="star-btn text-yellow-400" data-value="4">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            </button>
                            <button type="button" class="star-btn text-yellow-400" data-value="5">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            </button>
                        </div>
                        
                        <button type="submit" class="ml-4 bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg">Submit Rating</button>
                        <span id="ratingMessage" class="ml-3 text-sm"></span>
                    </form>
                </div>
            </div>
        </div>
</div>

<!-- JavaScript for rating functionality -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the rating form and elements
        const ratingForm = document.getElementById('ratingForm');
        const ratingStars = document.getElementById('ratingStars');
        const ratingValue = document.getElementById('ratingValue');
        const ratingMessage = document.getElementById('ratingMessage');
        
        if (ratingForm && ratingStars) {
            console.log('Rating form initialized');
            
            // Handle star selection
            const starButtons = ratingStars.querySelectorAll('.star-btn');
            starButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    ratingValue.value = value;
                    console.log('Star rating selected:', value);
                    
                    // Update star colors
                    starButtons.forEach(star => {
                        if (parseInt(star.getAttribute('data-value')) <= parseInt(value)) {
                            star.classList.add('text-yellow-400');
                            star.classList.remove('text-gray-300');
                        } else {
                            star.classList.add('text-gray-300');
                            star.classList.remove('text-yellow-400');
                        }
                    });
                });
            });
            
            // Handle form submission
            ratingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const recipeId = this.querySelector('input[name="recipeId"]').value;
                const rating = ratingValue.value;
                
                console.log('Submitting rating:', { recipeId, rating });
                
                if (!recipeId) {
                    console.error('Missing recipeId for rating submission');
                    ratingMessage.textContent = 'Error: Recipe ID is missing';
                    ratingMessage.className = 'ml-3 text-sm text-red-600';
                    return;
                }
                
                // Show loading state
                ratingMessage.textContent = 'Submitting rating...';
                ratingMessage.className = 'ml-3 text-sm text-blue-600';
                
                // Submit rating via AJAX
                fetch('/api/ratings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ recipeId, rating }),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Rating submission response:', data);
                    
                    if (data.success) {
                        ratingMessage.textContent = 'Thanks for your rating!';
                        ratingMessage.className = 'ml-3 text-sm text-green-600';
                    } else {
                        ratingMessage.textContent = data.message || 'Error submitting rating';
                        ratingMessage.className = 'ml-3 text-sm text-red-600';
                    }
                })
                .catch(error => {
                    console.error('Rating submission error:', error);
                    ratingMessage.textContent = 'Failed to submit rating. Try again later.';
                    ratingMessage.className = 'ml-3 text-sm text-red-600';
                });
            });
        }
    });
</script>
